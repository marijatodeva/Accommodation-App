apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-configmap
  namespace: accommodation-app
data:
  init.sql: |
    create type category_enum as ENUM ('ROOM', 'HOUSE', 'FLAT', 'APARTMENT', 'HOTEL', 'MOTEL');
    create table country
    (
        id          bigint generated by default as identity
            primary key,
        name        varchar(255),
        continent   varchar(255)
    );
    create table host
    (
        id          bigint generated by default as identity
            primary key,
        name        varchar(255),
        surname     varchar(255),
        country_id bigint references country
    );
    create table review
    (
        id          bigint generated by default as identity
            primary key,
        comment     varchar(255),
        rate        integer
    );
    create table accommodation
    (
        id          bigint generated by default as identity
            primary key,
        name        varchar(255),
        category    varchar(255),
        host_id     bigint references host,
        num_rooms   integer,
        is_rented   boolean default false
    );
    create table accommodation_review
    (
        review_id           bigint references review on delete cascade,
        accommodation_id    bigint references accommodation on delete cascade,
        primary key (review_id,accommodation_id)
    );
    create table accommodation_review_list
    (
        id               bigint generated by default as identity
            primary key,
        accommodation_id bigint references accommodation(id),
        review_list_id   bigint references review(id)
    );
    create table users
    (
        username                   varchar(255)
            primary key,
        password                   varchar(255),
        name                       varchar(255),
        surname                    varchar(255),
        is_account_non_expired     boolean default true,
        is_account_non_locked      boolean default true,
        is_credentials_non_expired boolean default true,
        is_enabled                 boolean default true,
        role                       varchar(50)
    );
    create table temporary_reservation
    (
        id                  bigint generated by default as identity
            primary key,
        user_username       varchar(255) references users
    );
    create table temporary_reservation_accommodations
    (
        temp_acc_id      bigint references temporary_reservation on delete cascade,
        acc_id           bigint references accommodation on delete cascade,
        primary key (temp_acc_id, acc_id)
    );
    create index idx_user_username_password on users (username, password);
    create index idx_user_username on users (username);
    create index idx_user_role on users (role);
    
    -- Insert sample data
    INSERT INTO country (name, continent) VALUES
                                              ('Macedonia', 'Europe'),
                                              ('Germany', 'Europe'),
                                              ('USA', 'North America'),
                                              ('Japan', 'Asia');
    
    INSERT INTO host (name, surname, country_id) VALUES
                                                     ('John', 'Doe', 1),
                                                     ('Jane', 'Smith', 2),
                                                     ('Mike', 'Johnson', 3),
                                                     ('Yuki', 'Tanaka', 4);
    
    INSERT INTO accommodation (name, category, host_id, num_rooms, is_rented) VALUES
                                                                                  ('Cozy Apartment in Skopje', 'APARTMENT', 1, 2, false),
                                                                                  ('Berlin City Hotel', 'HOTEL', 2, 50, false),
                                                                                  ('NYC Luxury Flat', 'FLAT', 3, 3, false),
                                                                                  ('Tokyo Traditional House', 'HOUSE', 4, 4, true);
    
    INSERT INTO review (comment, rate) VALUES
                                           ('Great place to stay!', 5),
                                           ('Very clean and comfortable', 4),
                                           ('Amazing location', 5),
                                           ('Good value for money', 4);
    
    INSERT INTO accommodation_review (review_id, accommodation_id) VALUES
                                                                       (1, 1),
                                                                       (2, 2),
                                                                       (3, 3),
                                                                       (4, 4);
    
    INSERT INTO users (username, password, name, surname, role) VALUES
                                                                    ('admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVajVG', 'Admin', 'User', 'ADMIN'),
                                                                    ('user1', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVajVG', 'Regular', 'User', 'USER');